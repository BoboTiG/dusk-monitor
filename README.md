# Dusk Node Monitoring

A minimalist dashboard for your Dusk node (go to the [preview](#preview), and check [similar projects](#similar-projects)). Here is [how to setup a node, in French](https://www.tiger-222.fr/luma/blockchain/node-dusk.html).

So far, we display:
- The current synchronized block (in red + a warning sign when behind the latest block).
- The slash count (in red + a warning sign when they happen).
- The generated blocks count.
- The current rewards value (+ a theoric total rewards accumulated so far).

ðŸ”” A nice sound will be played on new generated block, and this is totally optional. You can disable it by setting the `PLAY_SOUND=0` environment variable.

> [!TIP]
> Dusk wallet for tips:
> ```
> VKZpBrNtEeTobMgYkkdcGiZn8fK2Ve2yez429yRXrH4nUUDTuvr7Tv74xFA2DKNVegtF6jaom2uacZMm8Z2Lg2J
> ```

## Install

```bash
python3 -m venv venv
. ./venv/bin/activate
python -m pip install -r requirements.txt
```

## Setup

### On the Node

> [!IMPORTANT]
> The `rusk-wallet` environment variable must be exported (`export RUSK_WALLET_PWD='THE_PASSWORD' >> ~/.profile`).

Execute this script to append one shell function into the user profile file:

```bash
cat << 'EOF' >> ~/.profile

function get_node_info() {
    # Dusk Monitoring (https://github.com/BoboTiG/dusk-monitor)
    local current_block="$(ruskquery block-height)"
    local latest_block="$(API_ENDPOINT=https://nodes.dusk.network ruskquery block-height)"
    local stake_info="$(rusk-wallet stake-info 2>/dev/null)"
    local soft_slashes="$(echo "${stake_info}"| grep -E '^Slashes' | awk '{print $2}')"
    local hard_slashes="$(echo "${stake_info}"| grep -E '^Hard Slashes' | awk '{print $3}')"
    echo "${current_block} ${latest_block:-0} ${soft_slashes} ${hard_slashes}"
}
EOF
```

### On the Local Machine

> [!IMPORTANT]
> There are assumptions:
>
> 1. The SSH connection to the node is made via public key (and not a password).
> 2. There is a defined custom SSH `HostName` to connect to the node (`dusk` by default, and it can be tweaked by setting the `DUSK_SSH_HOSTNAME` environment variable).
>
> Here is a sample `~/.ssh/config` file to see what I mean:
>
> ```bash
> Host dusk
>     User USER
>     HostName IP
>     PreferredAuthentications publickey
> ```
>
> The app will issue that only one command as `ssh DUSK_SSH_HOSTNAME "source .profile ; get_node_info"` (nothing more, and you can inspect the source code to [double-check](https://github.com/search?q=repo:BoboTiG/dusk-monitor%20CMD_GET_NODE_INFO&type=code).

#### Data

A JSON file (`db.json`) will be created, and updated, as a database-like container. Those `db.json`, and `provisioner.txt`, files are stored at the root of the repository by default. You can move them to another place, and set the `DATA_DIR` environment variable accordingly:

```bash
DATA_DIR=../dusk-monitor-data/node-1 COMMAND
```

You will then have that tree:

```bash
../dusk-monitor-data
â””â”€â”€â”€ node-1
     â”œâ”€â”€ db.json
     â””â”€â”€ provisioner.txt
```

#### The Provisioner File

```bash
echo 'PROVISIONER_PUBLIC_KEY' > "${DATA_DIR:-.}/provisioner.txt"
```

## Run

### First Run

The very first run, you could:

1. Setup the [provisioner file](#the-provisioner-file).
1. [Update data](#update-data).
1. Setup the [daily cron job](#update-data).
1. Continue to [next runs](#next-runs).

### Next Runs

Then, you could:

1. Optionally, start the [listener](#listen-to-accepted-blocks) in one terminal, keep it running 7/7 24/24. It is convenient as it will update data in real-time, but the cron job will also take care of updates every day, in any cases.
1. Start the [web server](#web-server) in another terminal, keep it running as long as you want to have a visual on the dashboard.
1. That's it!

## Commands

### Listen to Accepted Blocks

An efficient way to keep track of accepted blocks is to listen to the blockchain directly:

```bash
python -m app --listen
```

### Update Data

You can update data on a regular basis, it will scan the entire blockchain for blocks generated by the node:

```bash
python -m app --update
```

Example of such a cron job that runs every day:

```bash
0 0 * * * cd /path/to/dusk-monitor && ./venv/bin/python -m app --update
```

### Web Server

Start the local web server at [http://localhost:1923](http://localhost:1923):

```bash
python -m app
```

## Preview

> [!NOTE]
> Those screenshots might be outdated, but the essence of the dashboard is still relevant from those pictures.

On desktop:

![Preview on a large screen](./screenshots/dusk-monitoring-large-screen.png)

On smartphone:

<img src="./screenshots/dusk-monitoring-small-screen.png" width="50%"/>

## Similar Projects

- [wolfrage76/DuskMan](https://github.com/wolfrage76/DuskMan/)
